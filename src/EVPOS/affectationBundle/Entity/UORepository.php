<?php

namespace EVPOS\affectationBundle\Entity;

use Doctrine\ORM\EntityRepository;

/**
* UORepository
*
* This class was generated by the Doctrine ORM. Add your own custom
* repository methods below.
*/
class UORepository extends EntityRepository
{
  /**
  * Récupération de la liste des UO
  */
  public function getListeUo() {
    $query = $this->createQueryBuilder('uo')
      ->orderBy('uo.codeUo')
      ->getQuery()
    ;

    return $query->getResult();
  }

  /**
  * Récupération d'une UO à partir de son code
  */
  public function getUo($codeUo) {
    $query = $this->createQueryBuilder('uo')
      ->setParameter('code', $codeUo)
      ->where('uo.codeUo = :code')
      ->getQuery()
    ;

    return $query->getOneOrNullResult();
  }

  /**
   * Retourne la liste des UO sans FIA
   */
  public function getSansFIA() {
    $query = $this->createQueryBuilder('uo')
      ->where('uo.avancementMoca = "1. Pas initiée"')
      ->getQuery()
    ;

    return $query->getResult();
  }

  /**
  * Récupération d'une UO et de toutes ses informations à partir de son code
  */
  public function getUoFull($codeUo) {
    $query = $this->createQueryBuilder('uo')
      ->setParameter('code', $codeUo)
      ->leftJoin('uo.listeAcces', 'a')
      ->addSelect('a')
      ->leftJoin('a.utilAcces', 'ua')
      ->addSelect('ua')
      ->leftJoin('ua.serviceUtil', 's')
      ->addSelect('s')
      ->leftJoin('s.direction', 'd')
      ->addSelect('d')
      ->where('uo.codeUo = :code')
      ->orderBy('d.codeDirection, s.codeService, ua.nomUtil')
      ->getQuery()
    ;

    return $query->getOneOrNullResult();
  }

  /**
  * Récupération de la liste des UO qui n'existent pas dans SUAPP
  **/
  public function getUoSupprimees() {
    $query = $this->createQueryBuilder('uo')
      ->where('uo.existeSuapp = FALSE')
      ->getQuery()
    ;

    return $query->getResult();
  }

  /**
  * Teste si l'UO dont le code est passé en parametre existe
  */
  public function isUo($codeUo) {
    $nbUo = $this->createQueryBuilder('u')
      ->select('count(u.codeUo)')
      ->setParameter('code', $codeUo)
      ->where('u.codeUo = :code')
      ->getQuery()
      ->getSingleScalarResult()
    ;

    if ($nbUo >= 1)
      $retour = true;
    else
      $retour = false;

    return $retour;
  }

  /**
   * Indicateurs d'avancement général des UO, par nature
   */
  public function getAvancementGeneral($nature) {
    $query = $this->createQueryBuilder('uo')
      ->select('uo.avancementMoca, count(uo.codeUo) nb')
      ->leftJoin('uo.appli', 'a')
      ->setParameter('nature', $nature)
      ->where("a.natAppli = :nature and uo.avancementMoca <> 'Non migré'")
      ->groupBy('uo.avancementMoca')
      ->orderBy('uo.avancementMoca', 'ASC')
      ->getQuery()
    ;

    return $query->getResult();
  }

  /**
   * Indicateurs d'avancement détaillé des UO, par nature
   */
  public function getAvancementDetail($nature) {
    $query = $this->createQueryBuilder('uo')
      ->select('uo.avancementMocaDetail, count(uo.codeUo) nb')
      ->leftJoin('uo.appli', 'a')
      ->setParameter('nature', $nature)
      ->where("a.natAppli = :nature and uo.avancementMocaDetail is not null")
      ->groupBy('uo.avancementMocaDetail')
      ->orderBy('uo.avancementMocaDetail', 'ASC')
      ->getQuery()
    ;
    return $query->getResult();
  }

  public function getNbUo($nature) {
    $query = $this->createQueryBuilder('uo')
      ->select('count(uo.codeUo) nb')
      ->leftJoin('uo.appli', 'a')
      ->setParameter('nature', $nature)
      ->where("a.natAppli = :nature and uo.avancementMoca <> 'Non migré'")
      ->getQuery()
    ;
    return $query->getOneOrNullResult();
  }

  /**
   * Liste des UO sans aucun utilisateur
   */
  public function getSansUtilisateur() {
    $query = $this->createQueryBuilder('uo')
      ->leftJoin('uo.appli', 'a')
      ->leftJoin('a.cpi', 'cpi')
      ->select('a.codeAppli, uo.codeUo, uo.nbUtil, cpi.matUtil, cpi.nomUtil')
      ->where('uo.nbUtil = 0')
      ->getQuery()
    ;
    return $query->getResult();
  }
}
