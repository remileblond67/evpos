<?php

namespace EVPOS\affectationBundle\Entity;

use Doctrine\ORM\EntityRepository;

/**
* HistPosteRepository
*
* This class was generated by the Doctrine ORM. Add your own custom
* repository methods below.
*/
class HistoPosteRepository extends EntityRepository {
  // Retourne l'historique du nombre de poste par jour
  public function getHistoPoste() {
    $query=$this->createQueryBuilder('h')
    ->select('h.dateMesure dateMesure, avg(h.nbPosteMoca) nbMoca, avg(h.nbPosteTodo) nbTodo')
    ->groupBy('h.dateMesure')
    ->orderBy('h.dateMesure')
    ->getQuery()
    ;
    return $query->getResult();
  }

  // Retourne l'historique du nombre de poste migrÃ© par semaine
  public function getHistoPosteSemaine() {
    $query=$this->createQueryBuilder('h')
    ->select('h.dateMesure dateMesure, avg(h.nbPosteMoca) nbMoca, avg(h.nbPosteTodo) nbTodo')
    ->groupBy('h.dateMesure')
    ->orderBy('h.dateMesure')
    ->getQuery()
    ;
    $resultSemaine = [];

    $old = 0;
    foreach ($query->getResult() as $ligne) {
      $semaine = date_format($ligne["dateMesure"], "Y-W");
      $resultSemaine[$semaine]["nb"] = $ligne["nbMoca"];
      $resultSemaine[$semaine]["diff"] = intval($ligne["nbMoca"]) - $old;
      $old = $ligne["nbMoca"];
    }
    return $resultSemaine;
  }
}
