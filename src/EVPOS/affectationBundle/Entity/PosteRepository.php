<?php

namespace EVPOS\affectationBundle\Entity;

use Doctrine\ORM\EntityRepository;
use Doctrine\ORM\Tools\Pagination\Paginator;

/**
 * PosteRepository
 *
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 */
class PosteRepository extends EntityRepository {
    
	/**
	 * Retourne le poste correspondant au hostname passé en paramètre
	 */
	public function getPoste($hostname) {
		$query = $this->createQueryBuilder('p')
            ->setParameter('hostname', $hostname)
            ->where('p.hostname = :hostname')
            ->getQuery()
        ;

        return $query->getOneOrNullResult();	
	}
	
	/**
     * Retourne la liste de tous les postes
     */
    public function getPostes() {
        $query = $this->createQueryBuilder('p')
            ->orderBy('p.hostname')
            ->getQuery()
        ;

        return $query->getResult();
    }

    /**
     * Retourne la liste de tous les postes non affectés à un service
     */
    public function getPostesSansService() {
        $query = $this->createQueryBuilder('p')
            ->orderBy('p.hostname')
            ->where('p.service is null')
            ->getQuery()
        ;

        return $query->getResult();
    }
    
    /**
     * Retourne la liste de tous les postes
     */
    public function getPostesPages($page, $nbParPage) {
        $query = $this->createQueryBuilder('p')
            ->orderBy('p.hostname')
            ->getQuery()
        ;

        $query
            ->setFirstResult(($page-1) * $nbParPage)
            ->setMaxResults($nbParPage)
        ;
        
        return new Paginator($query, true);
    }    
    
    /**
     * Retourne la liste de tous les postes et de leurs utilisateurs
     */
    public function getPostesUtil() {
        $query = $this->createQueryBuilder('p')
            ->leftJoin('p.listeUtilisateurs', 'u')
            ->addSelect('u')
            ->orderBy('p.hostname')
            ->getQuery()
        ;

        return $query->getResult();
    }
    
    /**
     * Retourne la liste des postes de postes sur lesquels sont installées des applications
     */
    public function getPosteUtilisateursAppli() {
        $query = $this->createQueryBuilder('p')
            ->leftJoin('p.listeUtilisateurs', 'u')
            ->addSelect('u')
            ->leftJoin('p.listeUo', 'uo')
            ->addSelect('uo')
            ->where('uo is not null and u is not null')
            ->getQuery()
        ;
        
        return $query->getResult();
    }
    
    /**
     * Retourne la liste des postes non trouvés dans GPARC
     */
    public function findNonGparc() {
        $query = $this->createQueryBuilder('p')
            ->where('p.existeGparc = FALSE')
            ->getQuery()
        ;

        return $query->getResult();
    }
    
    /**
     * Retourne le nombre de postes
     * Utilisé pour les indicateurs d'avancement
     */
    public function getNbPoste() {
        $query = $this->createQueryBuilder('p')
            ->select('count(p.hostname) nb')
            ->getQuery()
        ;

        return $query->getSingleScalarResult();
    }

    /**
     * Retourne le nombre de postes par type d'usage
     * Utilisé pour les indicateurs d'avancement
     */
    public function getNbPosteUsage() {
        $query = $this->createQueryBuilder('p')
            ->select('p.typeUsage, count(p.hostname) nb')
            ->groupBy('p.typeUsage')
            ->orderBy('nb', 'DESC')
            ->getQuery()
        ;

        return $query->getResult();
    }
}
